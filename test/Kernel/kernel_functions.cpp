//////////////////////////////////////////////////////////////////////////
// This file is part of openPSTD.                                       //
//                                                                      //
// openPSTD is free software: you can redistribute it and/or modify     //
// it under the terms of the GNU General Public License as published by //
// the Free Software Foundation, either version 3 of the License, or    //
// (at your option) any later version.                                  //
//                                                                      //
// openPSTD is distributed in the hope that it will be useful,          //
// but WITHOUT ANY WARRANTY; without even the implied warranty of       //
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        //
// GNU General Public License for more details.                         //
//                                                                      //
// You should have received a copy of the GNU General Public License    //
// along with openPSTD.  If not, see <http://www.gnu.org/licenses/>.    //
//                                                                      //
//////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////
//
// Date: 2-1-2016
//
//
// Authors: Omar Richardson
//
//
// Purpose: Test suite for kernel functions
//
//
//////////////////////////////////////////////////////////////////////////


#ifdef STAND_ALONE
#   define BOOST_TEST_MODULE Main
#endif

#include <boost/test/unit_test.hpp>
#include "../../kernel/core/kernel_functions.h"
#include <kernel/PSTDKernel.h>
#include <cmath>

using namespace OpenPSTD::Kernel;
using namespace std;
using namespace Eigen;
BOOST_AUTO_TEST_SUITE(kernel_functions)

    BOOST_AUTO_TEST_CASE(test_next_2_power) {
        BOOST_CHECK_EQUAL(next_2_power(42), 64);
        BOOST_CHECK_EQUAL(next_2_power(3.4), 4);
        BOOST_CHECK_EQUAL(next_2_power(0.1), 1);
    }

    BOOST_AUTO_TEST_CASE(test_rho_array_one_neighbour) {
        float air_dens = 1.2;
        float max_rho = 1E10;
        Array<float, 4, 2> velocity;
        Array<float, 4, 2> pressure;
        velocity << -1, 1, 0, 0, 2, 0, 1, 1;
        pressure << 1, -1, 0, 0, 2, 0, 1, 1;
        RhoArray rhoArray = get_rho_array(max_rho, air_dens, air_dens);
        BOOST_CHECK(rhoArray.pressure.isApprox(pressure));
        BOOST_CHECK(rhoArray.velocity.isApprox(velocity));
    }

    BOOST_AUTO_TEST_CASE(test_rho_array_two_neighbour) {
        float air_dens = 1.2;
        Array<float, 4, 2> velocity;
        Array<float, 4, 2> pressure;
        velocity << 0, 0, 0, 0, 1, 1, 1, 1;
        pressure << 0, 0, 0, 0, 1, 1, 1, 1;
        RhoArray rhoArray = get_rho_array(air_dens, air_dens, air_dens);
        BOOST_CHECK(rhoArray.pressure.isApprox(pressure));
        BOOST_CHECK(rhoArray.velocity.isApprox(velocity));
    }

    BOOST_AUTO_TEST_CASE(test_get_grid_spacing) {
        PSTDSettings settings;
        settings.SetSoundSpeed(340);
        settings.SetMaxFrequency(84000);
        BOOST_CHECK(get_grid_spacing(settings) <= 0.0020238);
        settings.SetSoundSpeed(340);
        settings.SetMaxFrequency(20000);
        BOOST_CHECK(get_grid_spacing(settings) <= 0.0085);
        settings.SetSoundSpeed(340);
        settings.SetMaxFrequency(200);
        BOOST_CHECK(get_grid_spacing(settings) <= 0.85);
        settings.SetSoundSpeed(340);
        settings.SetMaxFrequency(20);
        BOOST_CHECK(get_grid_spacing(settings) <= 8.5);
    }

    BOOST_AUTO_TEST_CASE(test_spatderp3) {
        Eigen::ArrayXXf d1(4, 50), d2p(4, 50), d2v(4,51), d3(4, 50);
        Eigen::ArrayXcf derfact_p(128), derfact_v(128);
        Eigen::ArrayXf real_p(128), imag_p(128), real_v(128), imag_v(128);

        d1 = Eigen::ArrayXXf::Zero(4, 50);
        d3 = Eigen::ArrayXXf::Zero(4, 50);

        d2p << -3.24603286e-01, -2.85451654e-01, -1.11821799e-01, 1.19716739e-01, 1.40688758e-01, -4.77024089e-02, -1.52506936e-01, -4.68348425e-03, 2.35881230e-01, 2.77858339e-01, 1.38547410e-01, 3.28795426e-02, 3.93223858e-03, 1.72202537e-04, 3.81372830e-05, -2.22032113e-05, 1.59622981e-05, -1.17796998e-05, 8.92666044e-06, -6.92367012e-06, 5.47995171e-06, -4.41436226e-06, 3.61100521e-06, -2.99378352e-06, 2.51149918e-06, -2.12891965e-06, 1.82129117e-06, -1.57088885e-06, 1.36479857e-06, -1.19346050e-06, 1.04969382e-06, -9.28031611e-07, 8.24259518e-07, -7.35090539e-07, 6.57932274e-07, -5.90717785e-07, 5.31780706e-07, -4.79761171e-07, 4.33532911e-07, -3.92143767e-07, 3.54761996e-07, -3.20617754e-07, 2.88920149e-07, -2.58666628e-07, 2.03913654e-07, -1.52264338e-07, 1.14065238e-07, -7.34075403e-08, 3.98490139e-08, -7.08863433e-09,
                -2.85451654e-01, -2.25236928e-01, -8.31637494e-02, 8.09794381e-02, 1.01719135e-01, -1.80270012e-02, -7.23868955e-02, 4.37989934e-02, 2.15616241e-01, 2.44573502e-01, 1.29158561e-01, 3.30841034e-02, 4.27441992e-03, 2.08961341e-04, 4.05210040e-05, -2.27204031e-05, 1.63324714e-05, -1.20389526e-05, 9.11335050e-06, -7.06139845e-06, 5.58372332e-06, -4.49398959e-06, 3.67308276e-06, -3.04285849e-06, 2.55078296e-06, -2.16073119e-06, 1.84734027e-06, -1.59246163e-06, 1.38288161e-06, -1.20882595e-06, 1.06295903e-06, -9.39702079e-07, 8.34760699e-07, -7.44792399e-07, 6.67169322e-07, -5.99806739e-07, 5.41037786e-07, -4.89521326e-07, 4.44174280e-07, -4.04123221e-07, 3.68674017e-07, -3.37307592e-07, 3.09754695e-07, -2.86550080e-07, 2.44050222e-07, -2.02035642e-07, 1.63248759e-07, -1.19086760e-07, 7.76020294e-08, -2.85594279e-08,
                -1.11821799e-01, -8.31637494e-02, -2.79315578e-02, 6.62571562e-02, 1.19129785e-01, 7.83537328e-02, 3.82578649e-02, 7.66494443e-02, 1.70617013e-01, 1.99810570e-01, 1.15896071e-01, 3.20891006e-02, 4.41125986e-03, 2.24728387e-04, 4.48018211e-05, -2.50729665e-05, 1.80530022e-05, -1.33234019e-05, 1.00959808e-05, -7.82932361e-06, 6.19510310e-06, -4.98868295e-06, 4.07907476e-06, -3.38023538e-06, 2.83425269e-06, -2.40126041e-06, 2.05324173e-06, -1.77013175e-06, 1.53731072e-06, -1.34395756e-06, 1.18194733e-06, -1.04509931e-06, 9.28655857e-07, -8.28915515e-07, 7.42971395e-07, -6.68522456e-07, 6.03736404e-07, -5.47150142e-07, 4.97599020e-07, -4.54170790e-07, 4.16187001e-07, -3.83232300e-07, 3.55333597e-07, -3.34015008e-07, 2.97556757e-07, -2.56247379e-07, 2.09693667e-07, -1.59982896e-07, 1.08060573e-07, -4.45497679e-08,
                1.19716739e-01, 8.09794381e-02, 6.62571562e-02, 1.45953554e-01, 2.18653430e-01, 1.71560835e-01, 7.50903268e-02, 5.04423070e-02, 1.24970892e-01, 1.67990685e-01, 1.01546613e-01, 2.81870297e-02, 3.85060228e-03, 1.85717473e-04, 4.33516742e-05, -2.50514693e-05, 1.80622348e-05, -1.33562714e-05, 1.01382047e-05, -7.87378086e-06, 6.23834706e-06, -5.02916897e-06, 4.11623073e-06, -3.41397520e-06, 2.86472172e-06, -2.42870269e-06, 2.07793157e-06, -1.79233944e-06, 1.55728626e-06, -1.36192400e-06, 1.19809874e-06, -1.05960125e-06, 9.41646595e-07, -8.40507440e-07, 7.53252049e-07, -6.77554818e-07, 6.11558065e-07, -5.53770809e-07, 5.02995381e-07, -4.58276837e-07, 4.18875550e-07, -3.84276518e-07, 3.54309113e-07, -3.29902179e-07, 2.90867581e-07, -2.44325426e-07, 1.94849731e-07, -1.47473860e-07, 9.53599040e-08, -3.81462239e-08;

        d2v << -7.58050475e-12, -1.58366952e-04, -2.07936546e-04, 7.54397423e-05, 5.40604912e-04, 5.63686461e-04, 1.03062363e-04, -1.91700279e-04, 8.31595699e-05, 5.96103392e-04, 6.75198731e-04, 3.36835780e-04, 8.03176795e-05, 9.65397762e-06, 4.17534020e-07, 9.74238215e-08, -5.73441933e-08, 4.13367391e-08, -3.05923817e-08, 2.32466156e-08, -1.80776587e-08, 1.43435390e-08, -1.15813429e-08, 9.49443358e-09, -7.88773212e-09, 6.62978146e-09, -5.62997485e-09, 4.82455413e-09, -4.16779502e-09, 3.62633281e-09, -3.17543184e-09, 2.79648450e-09, -2.47530345e-09, 2.20093550e-09, -1.96482435e-09, 1.76021032e-09, -1.58169309e-09, 1.42490752e-09, -1.28627748e-09, 1.16282160e-09, -1.05198784e-09, 9.51490744e-10, -8.59112674e-10, 7.72308273e-10, -6.27565825e-10, 4.89490796e-10, -3.78353328e-10, 2.67938093e-10, -1.67605007e-10, 7.19974055e-11, 8.23899790e-12,
                -1.99286543e-11, -1.01309391e-04, -9.51766343e-05, 1.38491619e-04, 4.75826928e-04, 4.83672614e-04, 1.33107369e-04, -7.43600093e-05, 1.49067380e-04, 5.41294683e-04, 6.03285143e-04, 3.17337752e-04, 8.11093312e-05, 1.04536679e-05, 5.09165419e-07, 9.87282162e-08, -5.55348404e-08, 3.99825654e-08, -2.95226177e-08, 2.23875482e-08, -1.73773482e-08, 1.37648874e-08, -1.10973941e-08, 9.08529184e-09, -7.53849883e-09, 6.32914946e-09, -5.36925683e-09, 4.59700140e-09, -3.96811387e-09, 3.45033690e-09, -3.01978988e-09, 2.65853559e-09, -2.35292147e-09, 2.09242979e-09, -1.86886820e-09, 1.67579199e-09, -1.50808653e-09, 1.36166289e-09, -1.23323518e-09, 1.12016023e-09, -1.02033159e-09, 9.32144263e-10, -8.54655914e-10, 7.88894339e-10, -6.76618596e-10, 5.66666914e-10, -4.65414345e-10, 3.57016326e-10, -2.50417606e-10, 1.35165901e-10, -6.44119753e-12,
                -3.02782003e-11, 9.39836988e-06, 5.38589173e-05, 1.75290968e-04, 3.77147359e-04, 4.26762806e-04, 2.30369550e-04, 8.17179218e-05, 1.86366530e-04, 4.37663982e-04, 5.04605884e-04, 2.87662939e-04, 7.88243827e-05, 1.07539904e-05, 5.48606963e-07, 1.06130597e-07, -5.92377767e-08, 4.27051048e-08, -3.15590456e-08, 2.39481378e-08, -1.85987370e-08, 1.47384763e-08, -1.18859478e-08, 9.73296706e-09, -8.07705472e-09, 6.78189089e-09, -5.75359910e-09, 4.92617649e-09, -4.25232986e-09, 3.69758152e-09, -3.23639775e-09, 2.84959594e-09, -2.52257623e-09, 2.24409570e-09, -2.00540574e-09, 1.79963737e-09, -1.62135884e-09, 1.46625643e-09, -1.33090669e-09, 1.21262364e-09, -1.10938222e-09, 1.01986345e-09, -9.43862009e-10, 8.84771755e-10, -7.89161760e-10, 6.85895274e-10, -5.74333501e-10, 4.55654192e-10, -3.32079178e-10, 1.90998234e-10, -1.65455795e-11,
                -2.67113372e-11, 7.25766502e-05, 9.17326932e-05, 1.37665599e-04, 3.30993973e-04, 4.56821397e-04, 3.22574942e-04, 1.33168875e-04, 1.36317115e-04, 3.38571114e-04, 4.27663121e-04, 2.51661276e-04, 6.91102314e-05, 9.38440791e-06, 4.53263845e-07, 1.03610914e-07, -5.98675679e-08, 4.32404125e-08, -3.20330188e-08, 2.43600686e-08, -1.89540703e-08, 1.50444688e-08, -1.21498491e-08, 9.96130338e-09, -8.27542635e-09, 6.95499105e-09, -5.90531562e-09, 5.05971382e-09, -4.37032541e-09, 3.80220695e-09, -3.32944341e-09, 2.93253946e-09, -2.59663734e-09, 2.31027950e-09, -2.06453610e-09, 1.85238202e-09, -1.66824689e-09, 1.50768831e-09, -1.36715546e-09, 1.24382442e-09, -1.13550126e-09, 1.04062366e-09, -9.58540092e-10, 8.91334522e-10, -7.89790582e-10, 6.74719677e-10, -5.53466520e-10, 4.34371923e-10, -3.09254120e-10, 1.72813841e-10, -1.17877236e-11;

        real_p << 0.00000000e+00, 3.01166185e-03, 1.20430192e-02, 2.70831905e-02, 4.81140512e-02, 7.51102496e-02, 1.08039230e-01, 1.46861262e-01, 1.91529476e-01, 2.41989907e-01, 2.98181542e-01, 3.60036376e-01, 4.27479473e-01, 5.00429034e-01, 5.78796470e-01, 6.62486486e-01, 7.51397162e-01, 8.45420051e-01, 9.44440271e-01, 1.04833662e+00, 1.15698166e+00, 1.27024188e+00, 1.38797777e+00, 1.51004397e+00, 1.63628940e+00, 1.76655741e+00, 1.90068588e+00, 2.03850743e+00, 2.17984953e+00, 2.32453465e+00, 2.47238048e+00, 2.62320003e+00, 2.77680184e+00, 2.93299013e+00, 3.09156503e+00, 3.25232270e+00, 3.41505557e+00, 3.57955249e+00, 3.74559896e+00, 3.91297732e+00, 4.08146692e+00, 4.25084437e+00, 4.42088374e+00, 4.59135674e+00, 4.76203297e+00, 4.93268010e+00, 5.10306413e+00, 5.27294956e+00, 5.44209966e+00, 5.61027667e+00, 5.77724203e+00, 5.94275659e+00, 6.10658086e+00, 6.26847523e+00, 6.42820020e+00, 6.58551662e+00, 6.74018588e+00, 6.89197020e+00, 7.04063282e+00, 7.18593822e+00, 7.32765241e+00, 7.46554307e+00, 7.59937988e+00, 7.72893466e+00, 7.85398163e+00, 7.72893466e+00, 7.59937988e+00, 7.46554307e+00, 7.32765241e+00, 7.18593822e+00, 7.04063282e+00, 6.89197020e+00, 6.74018588e+00, 6.58551662e+00, 6.42820020e+00, 6.26847523e+00, 6.10658086e+00, 5.94275659e+00, 5.77724203e+00, 5.61027667e+00, 5.44209966e+00, 5.27294956e+00, 5.10306413e+00, 4.93268010e+00, 4.76203297e+00, 4.59135674e+00, 4.42088374e+00, 4.25084437e+00, 4.08146692e+00, 3.91297732e+00, 3.74559896e+00, 3.57955249e+00, 3.41505557e+00, 3.25232270e+00, 3.09156503e+00, 2.93299013e+00, 2.77680184e+00, 2.62320003e+00, 2.47238048e+00, 2.32453465e+00, 2.17984953e+00, 2.03850743e+00, 1.90068588e+00, 1.76655741e+00, 1.63628940e+00, 1.51004397e+00, 1.38797777e+00, 1.27024188e+00, 1.15698166e+00, 1.04833662e+00, 9.44440271e-01, 8.45420051e-01, 7.51397162e-01, 6.62486486e-01, 5.78796470e-01, 5.00429034e-01, 4.27479473e-01, 3.60036376e-01, 2.98181542e-01, 2.41989907e-01, 1.91529476e-01, 1.46861262e-01, 1.08039230e-01, 7.51102496e-02, 4.81140512e-02, 2.70831905e-02, 1.20430192e-02, 3.01166185e-03;
        imag_p << +0.00000000e+00, 1.22681503e-01, +2.45141287e-01, 3.67157856e-01, +4.88510160e-01, 6.08977815e-01, +7.28341326e-01, 8.46382306e-01, +9.62883697e-01, 1.07762999e+00, +1.19040744e+00, 1.30100429e+00, +1.40921097e+00, 1.51482031e+00, +1.61762777e+00, 1.71743163e+00, +1.81403322e+00, 1.90723707e+00, +1.99685118e+00, 2.08268715e+00, +2.16456044e+00, 2.24229050e+00, +2.31570101e+00, 2.38462001e+00, +2.44888015e+00, 2.50831879e+00, +2.56277824e+00, 2.61210587e+00, +2.65615433e+00, 2.69478167e+00, +2.72785150e+00, 2.75523316e+00, +2.77680184e+00, 2.79243874e+00, +2.80203121e+00, 2.80547286e+00, +2.80266368e+00, 2.79351018e+00, +2.77792552e+00, 2.75582955e+00, +2.72714900e+00, 2.69181751e+00, +2.64977574e+00, 2.60097147e+00, +2.54535965e+00, 2.48290251e+00, +2.41356958e+00, 2.33733779e+00, +2.25419149e+00, 2.16412252e+00, +2.06713025e+00, 1.96322159e+00, +1.85241105e+00, 1.73472072e+00, +1.61018033e+00, 1.47882721e+00, +1.34070633e+00, 1.19587027e+00, +1.04437922e+00, 8.86300945e-01, +7.21710769e-01, 5.50691541e-01, +3.73333594e-01, 1.89734696e-01, +4.80917673e-16, 1.89734696e-01, -3.73333594e-01, 5.50691541e-01, -7.21710769e-01, 8.86300945e-01, -1.04437922e+00, 1.19587027e+00, -1.34070633e+00, 1.47882721e+00, -1.61018033e+00, 1.73472072e+00, -1.85241105e+00, 1.96322159e+00, -2.06713025e+00, 2.16412252e+00, -2.25419149e+00, 2.33733779e+00, -2.41356958e+00, 2.48290251e+00, -2.54535965e+00, 2.60097147e+00, -2.64977574e+00, 2.69181751e+00, -2.72714900e+00, 2.75582955e+00, -2.77792552e+00, 2.79351018e+00, -2.80266368e+00, 2.80547286e+00, -2.80203121e+00, 2.79243874e+00, -2.77680184e+00, 2.75523316e+00, -2.72785150e+00, 2.69478167e+00, -2.65615433e+00, 2.61210587e+00, -2.56277824e+00, 2.50831879e+00, -2.44888015e+00, 2.38462001e+00, -2.31570101e+00, 2.24229050e+00, -2.16456044e+00, 2.08268715e+00, -1.99685118e+00, 1.90723707e+00, -1.81403322e+00, 1.71743163e+00, -1.61762777e+00, 1.51482031e+00, -1.40921097e+00, 1.30100429e+00, -1.19040744e+00, 1.07762999e+00, -9.62883697e-01, 8.46382306e-01, -7.28341326e-01, 6.08977815e-01, -4.88510160e-01, 3.67157856e-01, -2.45141287e-01, 1.22681503e-01;

        real_v << 0.00000000e+00, -3.01166185e-03, -1.20430192e-02, -2.70831905e-02, -4.81140512e-02, -7.51102496e-02, -1.08039230e-01, -1.46861262e-01, -1.91529476e-01, -2.41989907e-01, -2.98181542e-01, -3.60036376e-01, -4.27479473e-01, -5.00429034e-01, -5.78796470e-01, -6.62486486e-01, -7.51397162e-01, -8.45420051e-01, -9.44440271e-01, -1.04833662e+00, -1.15698166e+00, -1.27024188e+00, -1.38797777e+00, -1.51004397e+00, -1.63628940e+00, -1.76655741e+00, -1.90068588e+00, -2.03850743e+00, -2.17984953e+00, -2.32453465e+00, -2.47238048e+00, -2.62320003e+00, -2.77680184e+00, -2.93299013e+00, -3.09156503e+00, -3.25232270e+00, -3.41505557e+00, -3.57955249e+00, -3.74559896e+00, -3.91297732e+00, -4.08146692e+00, -4.25084437e+00, -4.42088374e+00, -4.59135674e+00, -4.76203297e+00, -4.93268010e+00, -5.10306413e+00, -5.27294956e+00, -5.44209966e+00, -5.61027667e+00, -5.77724203e+00, -5.94275659e+00, -6.10658086e+00, -6.26847523e+00, -6.42820020e+00, -6.58551662e+00, -6.74018588e+00, -6.89197020e+00, -7.04063282e+00, -7.18593822e+00, -7.32765241e+00, -7.46554307e+00, -7.59937988e+00, -7.72893466e+00, -7.85398163e+00, -7.72893466e+00, -7.59937988e+00, -7.46554307e+00, -7.32765241e+00, -7.18593822e+00, -7.04063282e+00, -6.89197020e+00, -6.74018588e+00, -6.58551662e+00, -6.42820020e+00, -6.26847523e+00, -6.10658086e+00, -5.94275659e+00, -5.77724203e+00, -5.61027667e+00, -5.44209966e+00, -5.27294956e+00, -5.10306413e+00, -4.93268010e+00, -4.76203297e+00, -4.59135674e+00, -4.42088374e+00, -4.25084437e+00, -4.08146692e+00, -3.91297732e+00, -3.74559896e+00, -3.57955249e+00, -3.41505557e+00, -3.25232270e+00, -3.09156503e+00, -2.93299013e+00, -2.77680184e+00, -2.62320003e+00, -2.47238048e+00, -2.32453465e+00, -2.17984953e+00, -2.03850743e+00, -1.90068588e+00, -1.76655741e+00, -1.63628940e+00, -1.51004397e+00, -1.38797777e+00, -1.27024188e+00, -1.15698166e+00, -1.04833662e+00, -9.44440271e-01, -8.45420051e-01, -7.51397162e-01, -6.62486486e-01, -5.78796470e-01, -5.00429034e-01, -4.27479473e-01, -3.60036376e-01, -2.98181542e-01, -2.41989907e-01, -1.91529476e-01, -1.46861262e-01, -1.08039230e-01, -7.51102496e-02, -4.81140512e-02, -2.70831905e-02, -1.20430192e-02, -3.01166185e-03;
        imag_v << 0.00000000e+00, 1.22681503e-01, 2.45141287e-01, 3.67157856e-01, 4.88510160e-01, 6.08977815e-01, 7.28341326e-01, 8.46382306e-01, 9.62883697e-01, 1.07762999e+00, 1.19040744e+00, 1.30100429e+00, 1.40921097e+00, 1.51482031e+00, 1.61762777e+00, 1.71743163e+00, 1.81403322e+00, 1.90723707e+00, 1.99685118e+00, 2.08268715e+00, 2.16456044e+00, 2.24229050e+00, 2.31570101e+00, 2.38462001e+00, 2.44888015e+00, 2.50831879e+00, 2.56277824e+00, 2.61210587e+00, 2.65615433e+00, 2.69478167e+00, 2.72785150e+00, 2.75523316e+00, 2.77680184e+00, 2.79243874e+00, 2.80203121e+00, 2.80547286e+00, 2.80266368e+00, 2.79351018e+00, 2.77792552e+00, 2.75582955e+00, 2.72714900e+00, 2.69181751e+00, 2.64977574e+00, 2.60097147e+00, 2.54535965e+00, 2.48290251e+00, 2.41356958e+00, 2.33733779e+00, 2.25419149e+00, 2.16412252e+00, 2.06713025e+00, 1.96322159e+00, 1.85241105e+00, 1.73472072e+00, 1.61018033e+00, 1.47882721e+00, 1.34070633e+00, 1.19587027e+00, 1.04437922e+00, 8.86300945e-01, 7.21710769e-01, 5.50691541e-01, 3.73333594e-01, 1.89734696e-01, 4.80917673e-16, -1.89734696e-01, -3.73333594e-01, -5.50691541e-01, -7.21710769e-01, -8.86300945e-01, -1.04437922e+00, -1.19587027e+00, -1.34070633e+00, -1.47882721e+00, -1.61018033e+00, -1.73472072e+00, -1.85241105e+00, -1.96322159e+00, -2.06713025e+00, -2.16412252e+00, -2.25419149e+00, -2.33733779e+00, -2.41356958e+00, -2.48290251e+00, -2.54535965e+00, -2.60097147e+00, -2.64977574e+00, -2.69181751e+00, -2.72714900e+00, -2.75582955e+00, -2.77792552e+00, -2.79351018e+00, -2.80266368e+00, -2.80547286e+00, -2.80203121e+00, -2.79243874e+00, -2.77680184e+00, -2.75523316e+00, -2.72785150e+00, -2.69478167e+00, -2.65615433e+00, -2.61210587e+00, -2.56277824e+00, -2.50831879e+00, -2.44888015e+00, -2.38462001e+00, -2.31570101e+00, -2.24229050e+00, -2.16456044e+00, -2.08268715e+00, -1.99685118e+00, -1.90723707e+00, -1.81403322e+00, -1.71743163e+00, -1.61762777e+00, -1.51482031e+00, -1.40921097e+00, -1.30100429e+00, -1.19040744e+00, -1.07762999e+00, -9.62883697e-01, -8.46382306e-01, -7.28341326e-01, -6.08977815e-01, -4.88510160e-01, -3.67157856e-01, -2.45141287e-01, -1.22681503e-01;

        derfact_p.real() = real_p;
        derfact_p.imag() = imag_p;

        derfact_v.real() = real_v;
        derfact_v.imag() = imag_v;

        int wlen = 32;
        Eigen::ArrayXf window(65);
        window << 0.00316228,0.00858261,0.02007542,0.0412163 ,0.07551126,0.12530442,0.19087516,0.27012564,0.35896633,0.45219639,0.54452377,0.63140816,0.7095588 ,0.77707471,0.83331485,0.8786185 ,0.9139817 ,0.94076063,0.96043711,0.97445482,0.98411922,0.9905474 ,0.99465322,0.99715493,0.9985956 ,0.99936947,0.9997499 ,0.99991624,0.99997804,0.99999609,0.99999966,0.99999999,1.        ,0.99999999,0.99999966,0.99999609,0.99997804,0.99991624,0.9997499 ,0.99936947,0.9985956 ,0.99715493,0.99465322,0.9905474 ,0.98411922,0.97445482,0.96043711,0.94076063,0.9139817 ,0.8786185 ,0.83331485,0.77707471,0.7095588 ,0.63140816,0.54452377,0.45219639,0.35896633,0.27012564,0.19087516,0.12530442,0.07551126,0.0412163 ,0.02007542,0.00858261,0.00316228;

        RhoArray rho_array;
        ArrayXXf pres_rhos(4,2), velo_rhos(4,2);
        pres_rhos << 1, -1,
                     1, -1,
                     2, 2.40000009537e-200,
                     2, 2.40000009537e-200;
        velo_rhos << -1, 1,
                     -1, 1,
                     2.40000009537e-200, 2,
                     2.40000009537e-200, 2;
        rho_array.pressure = pres_rhos;
        rho_array.velocity = velo_rhos;

        Eigen::ArrayXXf spatresult_pres = spatderp3(d1, d2p, d3, derfact_p, rho_array, window, wlen,
                                                    CalculationType::PRESSURE, CalcDirection::X);
        Eigen::ArrayXXf spatresult_velo = spatderp3(d1, d2v, d3, derfact_p, rho_array, window, wlen,
                                                    CalculationType::VELOCITY, CalcDirection::X);

        Eigen::ArrayXXf spatexpectation_pres(4, 51), spatexpectation_velo(4, 50);
        spatexpectation_pres << 9.48218658e-09, 8.38630356e-02, 4.40489263e-01, 6.15305864e-01, 5.21041604e-02, -5.08039291e-01, -2.81865702e-01, 3.88074616e-01, 6.39532284e-01, 1.00898271e-01, -3.77159112e-01, -2.66010924e-01, -6.54932431e-02, -7.65603326e-03, -7.18890440e-05, -2.05020578e-04, 1.39207999e-04, -1.01644647e-04, 7.62603563e-05, -5.86342684e-05, 4.60561949e-05, -3.68554449e-05, 2.99742312e-05, -2.47249542e-05, 2.06493110e-05, -1.74346210e-05, 1.48629240e-05, -1.27792678e-05, 1.10714933e-05, -9.65706836e-06, 8.47433750e-06, -7.47659542e-06, 6.62800241e-06, -5.90072215e-06, 5.27288430e-06, -4.72711125e-06, 4.24943503e-06, -3.82848444e-06, 3.45485577e-06, -3.12059702e-06, 2.81873070e-06, -2.54268839e-06, 2.28527771e-06, -2.03490615e-06, 1.71565758e-06, -1.33435031e-06, 9.97665491e-07, -6.97014861e-07, 4.15938721e-07, -1.63919897e-07, -3.10636902e-08,
                5.22826300e-08, 1.46931625e-01, 3.60032493e-01, 4.32537303e-01, 5.21913082e-02, -3.26008719e-01, -1.47839721e-01, 3.03778943e-01, 4.54840510e-01, 7.21742922e-02, -3.10739376e-01, -2.43797415e-01, -6.59657484e-02, -8.43654990e-03, -1.07356243e-04, -2.28916290e-04, 1.53541652e-04, -1.11519336e-04, 8.32631875e-05, -6.37448641e-05, 4.98827462e-05, -3.97862802e-05, 3.22642646e-05, -2.65460056e-05, 2.21200857e-05, -1.86390201e-05, 1.58615065e-05, -1.36165988e-05, 1.17809632e-05, -1.02641217e-05, 8.99868060e-06, -7.93373584e-06, 7.03034414e-06, -6.25836095e-06, 5.59419962e-06, -5.01922093e-06, 4.51856070e-06, -4.08026595e-06, 3.69465108e-06, -3.35381197e-06, 3.05125133e-06, -2.78156852e-06, 2.54009863e-06, -2.32134490e-06, 2.05840733e-06, -1.73921203e-06, 1.42467230e-06, -1.10209451e-06, 7.68822201e-07, -4.17123741e-07, 2.00296773e-08,
                8.46199124e-08, 7.28762978e-02, 1.34102988e-01, 2.45992561e-01, 1.40041864e-01, -1.15206168e-01, -1.08670248e-01, 9.78054157e-02, 2.49973047e-01, 8.01154281e-02, -2.26011166e-01, -2.15146846e-01, -6.40462967e-02, -8.82056093e-03, -9.77234368e-05, -2.62823747e-04, 1.76230235e-04, -1.27877999e-04, 9.53929594e-05, -7.29724602e-05, 5.70617595e-05, -4.54816514e-05, 3.68600957e-05, -3.03100524e-05, 2.52433121e-05, -2.12604764e-05, 1.80843643e-05, -1.55187264e-05, 1.34220531e-05, -1.16905905e-05, 1.02471015e-05, -9.03328530e-06, 8.00457493e-06, -7.12650854e-06, 6.37216081e-06, -5.72030127e-06, 5.15405912e-06, -4.65994821e-06, 4.22715473e-06, -3.84702568e-06, 3.51272565e-06, -3.21906521e-06, 2.96255629e-06, -2.74127942e-06, 2.49437561e-06, -2.18590332e-06, 1.84037865e-06, -1.46376488e-06, 1.06289967e-06, -6.11740496e-07, 5.20203639e-08,
                7.13523409e-08, -1.03274909e-01, -4.80680822e-02, 2.12747661e-01, 1.96868459e-01, -1.27993668e-01, -2.54984948e-01, -6.62244366e-02, 2.03358281e-01, 1.18248496e-01, -1.81482168e-01, -1.89020651e-01, -5.62680479e-02, -7.72266002e-03, -4.13360428e-05, -2.54524257e-04, 1.72319138e-04, -1.25418813e-04, 9.38201214e-05, -7.19446711e-05, 5.63773803e-05, -4.50187408e-05, 3.65431176e-05, -3.00911002e-05, 2.50913130e-05, -2.11548480e-05, 1.80112019e-05, -1.54684610e-05, 1.33879812e-05, -1.16679328e-05, 1.02323875e-05, -9.02394399e-06, 7.99865595e-06, -7.12248827e-06, 6.36880320e-06, -5.71655340e-06, 5.14896755e-06, -4.65258472e-06, 4.21654056e-06, -3.83204018e-06, 3.49197558e-06, -3.19066396e-06, 2.92367675e-06, -2.68703397e-06, 2.42232974e-06, -2.09001803e-06, 1.72121043e-06, -1.34411927e-06, 9.54145330e-07, -5.29297792e-07, 3.37531925e-08;

        spatexpectation_velo << -4.04228694e-04, -1.54994656e-04, 7.19323285e-04, 1.24739946e-03, 6.25888499e-05, -1.23423600e-03, -7.84131493e-04, 7.24840545e-04, 1.37055528e-03, 1.91848858e-04, -9.13595248e-04, -6.46084986e-04, -1.59977337e-04, -1.88497210e-05, -1.36940920e-07, -5.31694946e-07, 3.62837822e-07, -2.65602863e-07, 1.99777209e-07, -1.53978808e-07, 1.21231229e-07, -9.72288503e-08, 7.92422360e-08, -6.54948782e-08, 5.48011268e-08, -4.63509818e-08, 3.95790546e-08, -3.40828547e-08, 2.95706529e-08, -2.58274896e-08, 2.26925604e-08, -2.00438849e-08, 1.77877268e-08, -1.58511718e-08, 1.41768351e-08, -1.27190249e-08, 1.14409090e-08, -1.03123679e-08, 9.30829151e-09, -8.40709530e-09, 7.58912021e-09, -6.83399781e-09, 6.11145697e-09, -5.23393420e-09, 4.20777326e-09, -3.27173565e-09, 2.42410901e-09, -1.62083078e-09, 8.71522507e-10, -1.91235570e-10,
                -2.63667141e-04, -7.08934714e-07, 5.93493871e-04, 9.01222316e-04, 2.47426956e-05, -9.41350620e-04, -5.51732721e-04, 5.88799608e-04, 1.04448180e-03, 1.55984506e-04, -7.69077581e-04, -5.99224998e-04, -1.61740475e-04, -2.06207543e-05, -2.62028062e-07, -5.57363120e-07, 3.74621232e-07, -2.72561103e-07, 2.03865535e-07, -1.56357421e-07, 1.22574376e-07, -9.79362300e-08, 7.95556479e-08, -6.55634857e-08, 5.47186235e-08, -4.61771890e-08, 3.93527374e-08, -3.38294842e-08, 2.93072025e-08, -2.55654573e-08, 2.24399110e-08, -1.98063265e-08, 1.75695732e-08, -1.56559483e-08, 1.40077321e-08, -1.25792716e-08, 1.13341281e-08, -1.02429716e-08, 9.28200720e-09, -8.43177227e-09, 7.67615994e-09, -7.00135804e-09, 6.39179275e-09, -5.68161054e-09, 4.84132714e-09, -4.02102273e-09, 3.20244291e-09, -2.36491852e-09, 1.49974405e-09, -5.64011360e-10,
                1.97101447e-05, 1.07555457e-04, 2.97866810e-04, 5.35428217e-04, 1.38892784e-04, -5.30982956e-04, -3.94248565e-04, 2.72664693e-04, 6.69576946e-04, 1.81661664e-04, -5.83662786e-04, -5.35038960e-04, -1.57330945e-04, -2.14529461e-05, -2.61418356e-07, -6.20043775e-07, 4.15887233e-07, -3.02161918e-07, 2.25709807e-07, -1.72906067e-07, 1.35402610e-07, -1.08081472e-07, 8.77200339e-08, -7.22344676e-08, 6.02425958e-08, -5.08055892e-08, 4.32716331e-08, -3.71790097e-08, 3.21946118e-08, -2.80740705e-08, 2.46353655e-08, -2.17410252e-08, 1.92859077e-08, -1.71886778e-08, 1.53857755e-08, -1.38270947e-08, 1.24728569e-08, -1.12913413e-08, 1.02572524e-08, -9.35059789e-09, 8.55605156e-09, -7.86290239e-09, 7.26447673e-09, -6.61074029e-09, 5.82398187e-09, -4.97545680e-09, 4.06988442e-09, -3.11391024e-09, 2.07315754e-09, -8.66682601e-10,
                1.88703006e-04, 3.98146592e-05, 9.39007738e-05, 5.12349492e-04, 3.41370927e-04, -3.64506094e-04, -5.01264355e-04, 4.21459019e-06, 5.45836063e-04, 2.43843737e-04, -4.77931229e-04, -4.69121168e-04, -1.37935877e-04, -1.87918113e-05, -1.13729277e-07, -6.08673108e-07, 4.12642068e-07, -3.00834415e-07, 2.25430402e-07, -1.73170908e-07, 1.35936668e-07, -1.08734342e-07, 8.84097813e-08, -7.29171221e-08, 6.08953984e-08, -5.14176692e-08, 4.38387526e-08, -3.77005693e-08, 3.26719297e-08, -2.85093893e-08, 2.50312793e-08, -2.21001489e-08, 1.96106871e-08, -1.74812785e-08, 1.56480134e-08, -1.40603827e-08, 1.26781488e-08, -1.14690548e-08, 1.04071431e-08, -9.47153988e-09, 8.64561899e-09, -7.91646883e-09, 7.27290909e-09, -6.57239007e-09, 5.72776481e-09, -4.81295289e-09, 3.87556023e-09, -2.91627344e-09, 1.89388998e-09, -7.54282335e-10;

        BOOST_CHECK(spatexpectation_pres.isApprox(spatresult_pres));
        BOOST_CHECK(spatexpectation_velo.isApprox(spatresult_velo));
    }

    BOOST_AUTO_TEST_CASE(window_generator) {
        Eigen::ArrayXf window_verify(65), wind_gen(65);
        window_verify << 0.00316228,0.00858261,0.02007542,0.0412163 ,0.07551126,0.12530442,0.19087516,0.27012564,0.35896633,0.45219639,0.54452377,0.63140816,0.7095588 ,0.77707471,0.83331485,0.8786185 ,0.9139817 ,0.94076063,0.96043711,0.97445482,0.98411922,0.9905474 ,0.99465322,0.99715493,0.9985956 ,0.99936947,0.9997499 ,0.99991624,0.99997804,0.99999609,0.99999966,0.99999999,1.        ,0.99999999,0.99999966,0.99999609,0.99997804,0.99991624,0.9997499 ,0.99936947,0.9985956 ,0.99715493,0.99465322,0.9905474 ,0.98411922,0.97445482,0.96043711,0.94076063,0.9139817 ,0.8786185 ,0.83331485,0.77707471,0.7095588 ,0.63140816,0.54452377,0.45219639,0.35896633,0.27012564,0.19087516,0.12530442,0.07551126,0.0412163 ,0.02007542,0.00858261,0.00316228;
        wind_gen = get_window_coefficients(32,70);
        BOOST_CHECK(window_verify.isApprox(wind_gen));
    }


BOOST_AUTO_TEST_SUITE_END()
