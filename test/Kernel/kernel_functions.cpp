//////////////////////////////////////////////////////////////////////////
// This file is part of openPSTD.                                       //
//                                                                      //
// openPSTD is free software: you can redistribute it and/or modify     //
// it under the terms of the GNU General Public License as published by //
// the Free Software Foundation, either version 3 of the License, or    //
// (at your option) any later version.                                  //
//                                                                      //
// openPSTD is distributed in the hope that it will be useful,          //
// but WITHOUT ANY WARRANTY; without even the implied warranty of       //
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the        //
// GNU General Public License for more details.                         //
//                                                                      //
// You should have received a copy of the GNU General Public License    //
// along with openPSTD.  If not, see <http://www.gnu.org/licenses/>.    //
//                                                                      //
//////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////
//
// Date: 2-1-2016
//
//
// Authors: Omar Richardson
//
//
// Purpose: Test suite for kernel functions
//
//
//////////////////////////////////////////////////////////////////////////


#ifdef STAND_ALONE
#   define BOOST_TEST_MODULE Main
#endif

#include <boost/test/unit_test.hpp>
#include "../../kernel/core/kernel_functions.h"
#include <kernel/PSTDKernel.h>
#include <cmath>

using namespace OpenPSTD::Kernel;
using namespace std;
using namespace Eigen;
BOOST_AUTO_TEST_SUITE(kernel_functions)

    BOOST_AUTO_TEST_CASE(test_next_2_power) {
        BOOST_CHECK_EQUAL(next_2_power(42), 64);
        BOOST_CHECK_EQUAL(next_2_power(3.4), 4);
        BOOST_CHECK_EQUAL(next_2_power(0.1), 1);
    }

    BOOST_AUTO_TEST_CASE(test_rho_array_one_neighbour) {
        float air_dens = 1.2;
        float max_rho = 1E10;
        Array<float, 4, 2> velocity;
        Array<float, 4, 2> pressure;
        velocity << -1, 1, 0, 0, 2, 0, 1, 1;
        pressure << 1, -1, 0, 0, 2, 0, 1, 1;
        RhoArray rhoArray = get_rho_array(max_rho, air_dens, air_dens);
        BOOST_CHECK(rhoArray.pressure.isApprox(pressure));
        BOOST_CHECK(rhoArray.velocity.isApprox(velocity));
    }

    BOOST_AUTO_TEST_CASE(test_rho_array_two_neighbour) {
        float air_dens = 1.2;
        Array<float, 4, 2> velocity;
        Array<float, 4, 2> pressure;
        velocity << 0, 0, 0, 0, 1, 1, 1, 1;
        pressure << 0, 0, 0, 0, 1, 1, 1, 1;
        RhoArray rhoArray = get_rho_array(air_dens, air_dens, air_dens);
        BOOST_CHECK(rhoArray.pressure.isApprox(pressure));
        BOOST_CHECK(rhoArray.velocity.isApprox(velocity));
    }

    BOOST_AUTO_TEST_CASE(test_get_grid_spacing) {
        PSTDSettings settings;
        settings.SetSoundSpeed(340);
        settings.SetMaxFrequency(84000);
        BOOST_CHECK(get_grid_spacing(settings) <= 0.0020238);
        settings.SetSoundSpeed(340);
        settings.SetMaxFrequency(20000);
        BOOST_CHECK(get_grid_spacing(settings) <= 0.0085);
        settings.SetSoundSpeed(340);
        settings.SetMaxFrequency(200);
        BOOST_CHECK(get_grid_spacing(settings) <= 0.85);
        settings.SetSoundSpeed(340);
        settings.SetMaxFrequency(20);
        BOOST_CHECK(get_grid_spacing(settings) <= 8.5);
    }

    BOOST_AUTO_TEST_CASE(test_spatderp3) {
        Eigen::ArrayXXf d1(4,50), d2(4,50), d3(4,50);
        Eigen::ArrayXcf derfact(128);
        Eigen::ArrayXf real(128), imag(128);

        d1 = Eigen::ArrayXXf::Zero(4,50);
        d3 = Eigen::ArrayXXf::Zero(4,50);

        d2 << -3.24603286e-01, -2.85451654e-01, -1.11821799e-01, 1.19716739e-01, 1.40688758e-01, -4.77024089e-02, -1.52506936e-01, -4.68348425e-03, 2.35881230e-01, 2.77858339e-01, 1.38547410e-01, 3.28795426e-02, 3.93223858e-03, 1.72202537e-04, 3.81372830e-05, -2.22032113e-05, 1.59622981e-05, -1.17796998e-05, 8.92666044e-06, -6.92367012e-06, 5.47995171e-06, -4.41436226e-06, 3.61100521e-06, -2.99378352e-06, 2.51149918e-06, -2.12891965e-06, 1.82129117e-06, -1.57088885e-06, 1.36479857e-06, -1.19346050e-06, 1.04969382e-06, -9.28031611e-07, 8.24259518e-07, -7.35090539e-07, 6.57932274e-07, -5.90717785e-07, 5.31780706e-07, -4.79761171e-07, 4.33532911e-07, -3.92143767e-07, 3.54761996e-07, -3.20617754e-07, 2.88920149e-07, -2.58666628e-07, 2.03913654e-07, -1.52264338e-07, 1.14065238e-07, -7.34075403e-08, 3.98490139e-08, -7.08863433e-09,
                -2.85451654e-01, -2.25236928e-01, -8.31637494e-02, 8.09794381e-02, 1.01719135e-01, -1.80270012e-02, -7.23868955e-02, 4.37989934e-02, 2.15616241e-01, 2.44573502e-01, 1.29158561e-01, 3.30841034e-02, 4.27441992e-03, 2.08961341e-04, 4.05210040e-05, -2.27204031e-05, 1.63324714e-05, -1.20389526e-05, 9.11335050e-06, -7.06139845e-06, 5.58372332e-06, -4.49398959e-06, 3.67308276e-06, -3.04285849e-06, 2.55078296e-06, -2.16073119e-06, 1.84734027e-06, -1.59246163e-06, 1.38288161e-06, -1.20882595e-06, 1.06295903e-06, -9.39702079e-07, 8.34760699e-07, -7.44792399e-07, 6.67169322e-07, -5.99806739e-07, 5.41037786e-07, -4.89521326e-07, 4.44174280e-07, -4.04123221e-07, 3.68674017e-07, -3.37307592e-07, 3.09754695e-07, -2.86550080e-07, 2.44050222e-07, -2.02035642e-07, 1.63248759e-07, -1.19086760e-07, 7.76020294e-08, -2.85594279e-08,
                -1.11821799e-01, -8.31637494e-02, -2.79315578e-02, 6.62571562e-02, 1.19129785e-01, 7.83537328e-02, 3.82578649e-02, 7.66494443e-02, 1.70617013e-01, 1.99810570e-01, 1.15896071e-01, 3.20891006e-02, 4.41125986e-03, 2.24728387e-04, 4.48018211e-05, -2.50729665e-05, 1.80530022e-05, -1.33234019e-05, 1.00959808e-05, -7.82932361e-06, 6.19510310e-06, -4.98868295e-06, 4.07907476e-06, -3.38023538e-06, 2.83425269e-06, -2.40126041e-06, 2.05324173e-06, -1.77013175e-06, 1.53731072e-06, -1.34395756e-06, 1.18194733e-06, -1.04509931e-06, 9.28655857e-07, -8.28915515e-07, 7.42971395e-07, -6.68522456e-07, 6.03736404e-07, -5.47150142e-07, 4.97599020e-07, -4.54170790e-07, 4.16187001e-07, -3.83232300e-07, 3.55333597e-07, -3.34015008e-07, 2.97556757e-07, -2.56247379e-07, 2.09693667e-07, -1.59982896e-07, 1.08060573e-07, -4.45497679e-08,
                1.19716739e-01, 8.09794381e-02, 6.62571562e-02, 1.45953554e-01, 2.18653430e-01, 1.71560835e-01, 7.50903268e-02, 5.04423070e-02, 1.24970892e-01, 1.67990685e-01, 1.01546613e-01, 2.81870297e-02, 3.85060228e-03, 1.85717473e-04, 4.33516742e-05, -2.50514693e-05, 1.80622348e-05, -1.33562714e-05, 1.01382047e-05, -7.87378086e-06, 6.23834706e-06, -5.02916897e-06, 4.11623073e-06, -3.41397520e-06, 2.86472172e-06, -2.42870269e-06, 2.07793157e-06, -1.79233944e-06, 1.55728626e-06, -1.36192400e-06, 1.19809874e-06, -1.05960125e-06, 9.41646595e-07, -8.40507440e-07, 7.53252049e-07, -6.77554818e-07, 6.11558065e-07, -5.53770809e-07, 5.02995381e-07, -4.58276837e-07, 4.18875550e-07, -3.84276518e-07, 3.54309113e-07, -3.29902179e-07, 2.90867581e-07, -2.44325426e-07, 1.94849731e-07, -1.47473860e-07, 9.53599040e-08, -3.81462239e-08;

        real << 0.00000000e+00, 3.01166185e-03, 1.20430192e-02, 2.70831905e-02, 4.81140512e-02, 7.51102496e-02, 1.08039230e-01, 1.46861262e-01, 1.91529476e-01, 2.41989907e-01, 2.98181542e-01, 3.60036376e-01, 4.27479473e-01, 5.00429034e-01, 5.78796470e-01, 6.62486486e-01, 7.51397162e-01, 8.45420051e-01, 9.44440271e-01, 1.04833662e+00, 1.15698166e+00, 1.27024188e+00, 1.38797777e+00, 1.51004397e+00, 1.63628940e+00, 1.76655741e+00, 1.90068588e+00, 2.03850743e+00, 2.17984953e+00, 2.32453465e+00, 2.47238048e+00, 2.62320003e+00, 2.77680184e+00, 2.93299013e+00, 3.09156503e+00, 3.25232270e+00, 3.41505557e+00, 3.57955249e+00, 3.74559896e+00, 3.91297732e+00, 4.08146692e+00, 4.25084437e+00, 4.42088374e+00, 4.59135674e+00, 4.76203297e+00, 4.93268010e+00, 5.10306413e+00, 5.27294956e+00, 5.44209966e+00, 5.61027667e+00, 5.77724203e+00, 5.94275659e+00, 6.10658086e+00, 6.26847523e+00, 6.42820020e+00, 6.58551662e+00, 6.74018588e+00, 6.89197020e+00, 7.04063282e+00, 7.18593822e+00, 7.32765241e+00, 7.46554307e+00, 7.59937988e+00, 7.72893466e+00, 7.85398163e+00, 7.72893466e+00, 7.59937988e+00, 7.46554307e+00, 7.32765241e+00, 7.18593822e+00, 7.04063282e+00, 6.89197020e+00, 6.74018588e+00, 6.58551662e+00, 6.42820020e+00, 6.26847523e+00, 6.10658086e+00, 5.94275659e+00, 5.77724203e+00, 5.61027667e+00, 5.44209966e+00, 5.27294956e+00, 5.10306413e+00, 4.93268010e+00, 4.76203297e+00, 4.59135674e+00, 4.42088374e+00, 4.25084437e+00, 4.08146692e+00, 3.91297732e+00, 3.74559896e+00, 3.57955249e+00, 3.41505557e+00, 3.25232270e+00, 3.09156503e+00, 2.93299013e+00, 2.77680184e+00, 2.62320003e+00, 2.47238048e+00, 2.32453465e+00, 2.17984953e+00, 2.03850743e+00, 1.90068588e+00, 1.76655741e+00, 1.63628940e+00, 1.51004397e+00, 1.38797777e+00, 1.27024188e+00, 1.15698166e+00, 1.04833662e+00, 9.44440271e-01, 8.45420051e-01, 7.51397162e-01, 6.62486486e-01, 5.78796470e-01, 5.00429034e-01, 4.27479473e-01, 3.60036376e-01, 2.98181542e-01, 2.41989907e-01, 1.91529476e-01, 1.46861262e-01, 1.08039230e-01, 7.51102496e-02, 4.81140512e-02, 2.70831905e-02, 1.20430192e-02, 3.01166185e-03;
        imag << +0.00000000e+00, 1.22681503e-01, +2.45141287e-01, 3.67157856e-01, +4.88510160e-01, 6.08977815e-01, +7.28341326e-01, 8.46382306e-01, +9.62883697e-01, 1.07762999e+00, +1.19040744e+00, 1.30100429e+00, +1.40921097e+00, 1.51482031e+00, +1.61762777e+00, 1.71743163e+00, +1.81403322e+00, 1.90723707e+00, +1.99685118e+00, 2.08268715e+00, +2.16456044e+00, 2.24229050e+00, +2.31570101e+00, 2.38462001e+00, +2.44888015e+00, 2.50831879e+00, +2.56277824e+00, 2.61210587e+00, +2.65615433e+00, 2.69478167e+00, +2.72785150e+00, 2.75523316e+00, +2.77680184e+00, 2.79243874e+00, +2.80203121e+00, 2.80547286e+00, +2.80266368e+00, 2.79351018e+00, +2.77792552e+00, 2.75582955e+00, +2.72714900e+00, 2.69181751e+00, +2.64977574e+00, 2.60097147e+00, +2.54535965e+00, 2.48290251e+00, +2.41356958e+00, 2.33733779e+00, +2.25419149e+00, 2.16412252e+00, +2.06713025e+00, 1.96322159e+00, +1.85241105e+00, 1.73472072e+00, +1.61018033e+00, 1.47882721e+00, +1.34070633e+00, 1.19587027e+00, +1.04437922e+00, 8.86300945e-01, +7.21710769e-01, 5.50691541e-01, +3.73333594e-01, 1.89734696e-01, +4.80917673e-16, 1.89734696e-01, -3.73333594e-01, 5.50691541e-01, -7.21710769e-01, 8.86300945e-01, -1.04437922e+00, 1.19587027e+00, -1.34070633e+00, 1.47882721e+00, -1.61018033e+00, 1.73472072e+00, -1.85241105e+00, 1.96322159e+00, -2.06713025e+00, 2.16412252e+00, -2.25419149e+00, 2.33733779e+00, -2.41356958e+00, 2.48290251e+00, -2.54535965e+00, 2.60097147e+00, -2.64977574e+00, 2.69181751e+00, -2.72714900e+00, 2.75582955e+00, -2.77792552e+00, 2.79351018e+00, -2.80266368e+00, 2.80547286e+00, -2.80203121e+00, 2.79243874e+00, -2.77680184e+00, 2.75523316e+00, -2.72785150e+00, 2.69478167e+00, -2.65615433e+00, 2.61210587e+00, -2.56277824e+00, 2.50831879e+00, -2.44888015e+00, 2.38462001e+00, -2.31570101e+00, 2.24229050e+00, -2.16456044e+00, 2.08268715e+00, -1.99685118e+00, 1.90723707e+00, -1.81403322e+00, 1.71743163e+00, -1.61762777e+00, 1.51482031e+00, -1.40921097e+00, 1.30100429e+00, -1.19040744e+00, 1.07762999e+00, -9.62883697e-01, 8.46382306e-01, -7.28341326e-01, 6.08977815e-01, -4.88510160e-01, 3.67157856e-01, -2.45141287e-01, 1.22681503e-01;

        derfact.real() = real;
        derfact.imag() = imag;

        int wlen = 32;
        Eigen::ArrayXf window(65);
        window << 0.00316228,0.00858261,0.02007542,0.0412163 ,0.07551126,0.12530442,0.19087516,0.27012564,0.35896633,0.45219639,0.54452377,0.63140816,0.7095588 ,0.77707471,0.83331485,0.8786185 ,0.9139817 ,0.94076063,0.96043711,0.97445482,0.98411922,0.9905474 ,0.99465322,0.99715493,0.9985956 ,0.99936947,0.9997499 ,0.99991624,0.99997804,0.99999609,0.99999966,0.99999999,1.        ,0.99999999,0.99999966,0.99999609,0.99997804,0.99991624,0.9997499 ,0.99936947,0.9985956 ,0.99715493,0.99465322,0.9905474 ,0.98411922,0.97445482,0.96043711,0.94076063,0.9139817 ,0.8786185 ,0.83331485,0.77707471,0.7095588 ,0.63140816,0.54452377,0.45219639,0.35896633,0.27012564,0.19087516,0.12530442,0.07551126,0.0412163 ,0.02007542,0.00858261,0.00316228;

        RhoArray rho_array;
        ArrayXXf pres_rhos(4,2);
        pres_rhos << 1, -1,
                     1, -1,
                     2, 2.40000009537e-200,
                     2, 2.40000009537e-200;
        rho_array.pressure = pres_rhos;

        Eigen::ArrayXXf spatresult = spatderp3(d1, d2, d3, derfact, rho_array, window, wlen,
                                  CalculationType::PRESSURE, CalcDirection::X);

        Eigen::ArrayXXf spatexpectation(4,51);
        spatexpectation <<  9.48218658e-09, 8.38630356e-02, 4.40489263e-01, 6.15305864e-01, 5.21041604e-02, -5.08039291e-01, -2.81865702e-01, 3.88074616e-01, 6.39532284e-01, 1.00898271e-01, -3.77159112e-01, -2.66010924e-01, -6.54932431e-02, -7.65603326e-03, -7.18890440e-05, -2.05020578e-04, 1.39207999e-04, -1.01644647e-04, 7.62603563e-05, -5.86342684e-05, 4.60561949e-05, -3.68554449e-05, 2.99742312e-05, -2.47249542e-05, 2.06493110e-05, -1.74346210e-05, 1.48629240e-05, -1.27792678e-05, 1.10714933e-05, -9.65706836e-06, 8.47433750e-06, -7.47659542e-06, 6.62800241e-06, -5.90072215e-06, 5.27288430e-06, -4.72711125e-06, 4.24943503e-06, -3.82848444e-06, 3.45485577e-06, -3.12059702e-06, 2.81873070e-06, -2.54268839e-06, 2.28527771e-06, -2.03490615e-06, 1.71565758e-06, -1.33435031e-06, 9.97665491e-07, -6.97014861e-07, 4.15938721e-07, -1.63919897e-07, -3.10636902e-08,
                5.22826300e-08, 1.46931625e-01, 3.60032493e-01, 4.32537303e-01, 5.21913082e-02, -3.26008719e-01, -1.47839721e-01, 3.03778943e-01, 4.54840510e-01, 7.21742922e-02, -3.10739376e-01, -2.43797415e-01, -6.59657484e-02, -8.43654990e-03, -1.07356243e-04, -2.28916290e-04, 1.53541652e-04, -1.11519336e-04, 8.32631875e-05, -6.37448641e-05, 4.98827462e-05, -3.97862802e-05, 3.22642646e-05, -2.65460056e-05, 2.21200857e-05, -1.86390201e-05, 1.58615065e-05, -1.36165988e-05, 1.17809632e-05, -1.02641217e-05, 8.99868060e-06, -7.93373584e-06, 7.03034414e-06, -6.25836095e-06, 5.59419962e-06, -5.01922093e-06, 4.51856070e-06, -4.08026595e-06, 3.69465108e-06, -3.35381197e-06, 3.05125133e-06, -2.78156852e-06, 2.54009863e-06, -2.32134490e-06, 2.05840733e-06, -1.73921203e-06, 1.42467230e-06, -1.10209451e-06, 7.68822201e-07, -4.17123741e-07, 2.00296773e-08,
                8.46199124e-08, 7.28762978e-02, 1.34102988e-01, 2.45992561e-01, 1.40041864e-01, -1.15206168e-01, -1.08670248e-01, 9.78054157e-02, 2.49973047e-01, 8.01154281e-02, -2.26011166e-01, -2.15146846e-01, -6.40462967e-02, -8.82056093e-03, -9.77234368e-05, -2.62823747e-04, 1.76230235e-04, -1.27877999e-04, 9.53929594e-05, -7.29724602e-05, 5.70617595e-05, -4.54816514e-05, 3.68600957e-05, -3.03100524e-05, 2.52433121e-05, -2.12604764e-05, 1.80843643e-05, -1.55187264e-05, 1.34220531e-05, -1.16905905e-05, 1.02471015e-05, -9.03328530e-06, 8.00457493e-06, -7.12650854e-06, 6.37216081e-06, -5.72030127e-06, 5.15405912e-06, -4.65994821e-06, 4.22715473e-06, -3.84702568e-06, 3.51272565e-06, -3.21906521e-06, 2.96255629e-06, -2.74127942e-06, 2.49437561e-06, -2.18590332e-06, 1.84037865e-06, -1.46376488e-06, 1.06289967e-06, -6.11740496e-07, 5.20203639e-08,
                7.13523409e-08, -1.03274909e-01, -4.80680822e-02, 2.12747661e-01, 1.96868459e-01, -1.27993668e-01, -2.54984948e-01, -6.62244366e-02, 2.03358281e-01, 1.18248496e-01, -1.81482168e-01, -1.89020651e-01, -5.62680479e-02, -7.72266002e-03, -4.13360428e-05, -2.54524257e-04, 1.72319138e-04, -1.25418813e-04, 9.38201214e-05, -7.19446711e-05, 5.63773803e-05, -4.50187408e-05, 3.65431176e-05, -3.00911002e-05, 2.50913130e-05, -2.11548480e-05, 1.80112019e-05, -1.54684610e-05, 1.33879812e-05, -1.16679328e-05, 1.02323875e-05, -9.02394399e-06, 7.99865595e-06, -7.12248827e-06, 6.36880320e-06, -5.71655340e-06, 5.14896755e-06, -4.65258472e-06, 4.21654056e-06, -3.83204018e-06, 3.49197558e-06, -3.19066396e-06, 2.92367675e-06, -2.68703397e-06, 2.42232974e-06, -2.09001803e-06, 1.72121043e-06, -1.34411927e-06, 9.54145330e-07, -5.29297792e-07, 3.37531925e-08;

        BOOST_CHECK(true);
    }


BOOST_AUTO_TEST_SUITE_END()
